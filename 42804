<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ù…Ø§Ø´ÛŒÙ† Ø¨Ù„Ø§Ú©Ú†ÛŒÙ†ÛŒ</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <style>
        * {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            color: white;
            text-align: center;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 255, 0.5);
        }
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00f7ff;
        }
        .section {
            background: rgba(30, 30, 60, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #4d4dff;
        }
        button {
            background: linear-gradient(to right, #4e54c8, #8f94fb);
            color: white;
            border: none;
            padding: 15px 25px;
            margin: 10px;
            border-radius: 50px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 255, 0.6);
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .wallet-info {
            font-size: 1.1rem;
            margin: 15px;
            padding: 10px;
            background: rgba(0, 0, 50, 0.6);
            border-radius: 10px;
            display: inline-block;
        }
        .tracks {
            position: relative;
            height: 300px;
            margin: 30px 0;
            overflow: hidden;
        }
        .track {
            height: 100px;
            border-bottom: 3px dashed #4d4dff;
            position: relative;
        }
        .car {
            position: absolute;
            left: 20px;
            width: 80px;
            transition: left 0.5s ease-out;
            z-index: 10;
        }
        .finish-line {
            position: absolute;
            right: 100px;
            height: 100%;
            width: 5px;
            background: repeating-linear-gradient(
                to bottom,
                #fff,
                #fff 10px,
                #ff0000 10px,
                #ff0000 20px
            );
            z-index: 5;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
        }
        .control-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            font-size: 1.5rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #btnA {
            background: linear-gradient(to bottom, #ff416c, #ff4b2b);
        }
        #btnL {
            background: linear-gradient(to bottom, #11998e, #38ef7d);
        }
        .status {
            font-size: 1.3rem;
            margin: 15px 0;
            min-height: 30px;
        }
        .entry-options {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        .entry-btn {
            width: 120px;
            height: 120px;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.1rem;
        }
        .countdown {
            font-size: 5rem;
            font-weight: bold;
            text-shadow: 0 0 20px #ff0000;
            margin: 20px 0;
        }
        .hidden {
            display: none;
        }
        .players-waiting {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        .player-card {
            background: rgba(100, 100, 200, 0.3);
            padding: 10px;
            border-radius: 10px;
            min-width: 120px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš— Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ù…Ø§Ø´ÛŒÙ† Ø¨Ù„Ø§Ú©Ú†ÛŒÙ†ÛŒ</h1>
        
        <div id="connectSection" class="section">
            <h2>Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„</h2>
            <button id="connectWallet">Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„</button>
            <div id="walletInfo" class="wallet-info hidden">
                <div>Ø¢Ø¯Ø±Ø³: <span id="walletAddress"></span></div>
                <div>Ù…ÙˆØ¬ÙˆØ¯ÛŒ: <span id="tokenBalance"></span> TOKEN</div>
            </div>
        </div>
        
        <div id="entrySection" class="section hidden">
            <h2>Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø·Ø­ Ø¨Ø§Ø²ÛŒ</h2>
            <div class="entry-options">
                <button class="entry-btn" data-amount="100">100 ØªÙˆÚ©Ù†<br>Ø³Ø·Ø­ Û±</button>
                <button class="entry-btn" data-amount="200">200 ØªÙˆÚ©Ù†<br>Ø³Ø·Ø­ Û²</button>
                <button class="entry-btn" data-amount="400">400 ØªÙˆÚ©Ù†<br>Ø³Ø·Ø­ Û³</button>
                <button class="entry-btn" data-amount="1000">1000 ØªÙˆÚ©Ù†<br>Ø³Ø·Ø­ Û´</button>
            </div>
        </div>
        
        <div id="waitingSection" class="section hidden">
            <h2>Ù…Ù†ØªØ¸Ø± Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ø¯ÛŒÚ¯Ø±...</h2>
            <div id="countdown" class="countdown hidden">3</div>
            <div class="players-waiting">
                <div class="player-card" id="player1">Ø¨Ø§Ø²ÛŒÚ©Ù† Û±</div>
                <div class="player-card" id="player2">Ø¨Ø§Ø²ÛŒÚ©Ù† Û²</div>
                <div class="player-card" id="player3">Ø¨Ø§Ø²ÛŒÚ©Ù† Û³</div>
            </div>
        </div>
        
        <div id="raceSection" class="section hidden">
            <h2>Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ø¯Ø± Ø¬Ø±ÛŒØ§Ù†!</h2>
            <div class="tracks">
                <div class="track" style="top: 0;">
                    <img src="https://i.ibb.co/7WpJ7V6/red-car.png" class="car" id="car1">
                    <div class="finish-line"></div>
                </div>
                <div class="track" style="top: 100px;">
                    <img src="https://i.ibb.co/3yKsVWD/blue-car.png" class="car" id="car2">
                    <div class="finish-line"></div>
                </div>
                <div class="track" style="top: 200px;">
                    <img src="https://i.ibb.co/0K7R8qB/green-car.png" class="car" id="car3">
                    <div class="finish-line"></div>
                </div>
            </div>
            
            <div class="controls">
                <button id="btnA" class="control-btn">ğŸ…°ï¸<br>Ø­Ø±Ú©Øª Ø¹Ø§Ø¯ÛŒ<br>(1 Ù‚Ø¯Ù…)</button>
                <button id="btnL" class="control-btn">âš¡<br>Ø­Ø±Ú©Øª Ø³Ø±ÛŒØ¹<br>(2 Ù‚Ø¯Ù…)</button>
            </div>
            
            <div class="status" id="gameStatus">Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ù…Ø³Ø§Ø¨Ù‚Ù‡...</div>
        </div>
        
        <div id="resultSection" class="section hidden">
            <h2>Ù†ØªÛŒØ¬Ù‡ Ù…Ø³Ø§Ø¨Ù‚Ù‡</h2>
            <div id="winnerInfo" class="status"></div>
            <button id="playAgain">Ø¨Ø§Ø²ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡</button>
        </div>
    </div>

    <script>
        // =============== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ===============
        // ÙÙ‚Ø· Ú©Ø§ÙÛŒØ³Øª Ø¢Ø¯Ø±Ø³ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø´Ø¯Ù‡ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
        const CONTRACT_ADDRESS = "0x0c3ca1c1345fcbb1abecdbefe064ff7d019ca19b";
        
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø«Ø§Ø¨Øª (Ø§Ø² Ø·Ø±Ù Ø´Ù…Ø§)
        const TOKEN_ADDRESS = "0x259115680169276d0e4286acba362460456697c5";
        const OWNER_ADDRESS = "0xec54951C7d4619256Ea01C811fFdFa01A9925683";
        
        // ABI Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ù‡ÙˆØ´Ù…Ù†Ø¯
        const ABI = [
            {
                "inputs": [
                    {"internalType": "address", "name": "_tokenAddress", "type": "address"}
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": false, "internalType": "address", "name": "player", "type": "address"}
                ],
                "name": "PlayerJoined",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [],
                "name": "RaceStarted",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": false, "internalType": "address", "name": "player", "type": "address"},
                    {"indexed": false, "internalType": "uint256", "name": "newPosition", "type": "uint256"}
                ],
                "name": "MoveMade",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": false, "internalType": "address", "name": "winner", "type": "address"},
                    {"indexed": false, "internalType": "uint256", "name": "prize", "type": "uint256"}
                ],
                "name": "WinnerDeclared",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "FINISH_LINE",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "entryFee",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address", "name": "", "type": "address"}],
                "name": "hasJoined",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "_entryFee", "type": "uint256"}
                ],
                "name": "joinGame",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "bool", "name": "isA", "type": "bool"}
                ],
                "name": "moveCar",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "playerCount",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address", "name": "", "type": "address"}],
                "name": "playerIndex",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "name": "players",
                "outputs": [
                    {"internalType": "address", "name": "wallet", "type": "address"},
                    {"internalType": "uint256", "name": "position", "type": "uint256"},
                    {"internalType": "bool", "name": "lastMoveWasA", "type": "bool"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "raceEndTime",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "raceStarted",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "resetGame",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "token",
                "outputs": [{"internalType": "contract IERC20", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "winner",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getPlayers",
                "outputs": [{"internalType": "address[3]", "name": "", "type": "address[3]"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{"internalType": "address", "name": "_player", "type": "address"}],
                "name": "getPlayerIndex",
                "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];
        
        // =============== Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¬Ù‡Ø§Ù†ÛŒ ===============
        let provider, signer, contract, userAddress;
        let entryFee = 0;
        let lastMoveType = null;
        let countdownInterval;
        
        // =============== Ø¹Ù†Ø§ØµØ± DOM ===============
        const connectWalletBtn = document.getElementById('connectWallet');
        const walletInfoDiv = document.getElementById('walletInfo');
        const walletAddressSpan = document.getElementById('walletAddress');
        const tokenBalanceSpan = document.getElementById('tokenBalance');
        const entrySection = document.getElementById('entrySection');
        const waitingSection = document.getElementById('waitingSection');
        const raceSection = document.getElementById('raceSection');
        const resultSection = document.getElementById('resultSection');
        const countdownDiv = document.getElementById('countdown');
        const gameStatusDiv = document.getElementById('gameStatus');
        const winnerInfoDiv = document.getElementById('winnerInfo');
        const playAgainBtn = document.getElementById('playAgain');
        const car1 = document.getElementById('car1');
        const car2 = document.getElementById('car2');
        const car3 = document.getElementById('car3');
        const btnA = document.getElementById('btnA');
        const btnL = document.getElementById('btnL');
        const player1Div = document.getElementById('player1');
        const player2Div = document.getElementById('player2');
        const player3Div = document.getElementById('player3');
        
        // =============== Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„ ===============
        connectWalletBtn.addEventListener('click', connectWallet);
        
        // =============== Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ø·Ø­ Ø¨Ø§Ø²ÛŒ ===============
        document.querySelectorAll('.entry-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                entryFee = parseInt(btn.dataset.amount);
                joinGame(entryFee);
            });
        });
        
        // =============== Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒ ===============
        btnA.addEventListener('click', () => makeMove(true));
        btnL.addEventListener('click', () => makeMove(false));
        
        // =============== Ø¨Ø§Ø²ÛŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ===============
        playAgainBtn.addEventListener('click', () => {
            resultSection.classList.add('hidden');
            entrySection.classList.remove('hidden');
        });
        
        // =============== ØªØ§Ø¨Ø¹ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„ ===============
        async function connectWallet() {
            if (window.ethereum) {
                try {
                    // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©ÛŒÙ Ù¾ÙˆÙ„
                    walletAddressSpan.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                    await updateTokenBalance();
                    
                    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
                    walletInfoDiv.classList.remove('hidden');
                    connectWalletBtn.textContent = "Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯ Ú©ÛŒÙ Ù¾ÙˆÙ„";
                    entrySection.classList.remove('hidden');
                    
                    // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒ
                    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                    
                    // ØªÙ†Ø¸ÛŒÙ… Ú¯ÙˆØ´â€ŒØ¯Ù‡ÛŒ Ø¨Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
                    setupEventListeners();
                    
                } catch (error) {
                    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„:", error);
                    gameStatusDiv.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„";
                }
            } else {
                alert("Ù„Ø·ÙØ§Ù‹ MetaMask Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯!");
            }
        }
        
        // =============== Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ ØªÙˆÚ©Ù† ===============
        async function updateTokenBalance() {
            try {
                const tokenContract = new ethers.Contract(
                    TOKEN_ADDRESS, 
                    ['function balanceOf(address) view returns (uint256)'], 
                    provider
                );
                
                const balance = await tokenContract.balanceOf(userAddress);
                tokenBalanceSpan.textContent = ethers.utils.formatUnits(balance, 18);
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ:", error);
            }
        }
        
        // =============== ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ ===============
        async function joinGame(fee) {
            try {
                gameStatusDiv.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª Ù‡Ø²ÛŒÙ†Ù‡ ÙˆØ±ÙˆØ¯ÛŒ...";
                
                // Ø§ÛŒØ¬Ø§Ø¯ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ØªÙˆÚ©Ù†
                const tokenContract = new ethers.Contract(
                    TOKEN_ADDRESS, 
                    [
                        'function balanceOf(address) view returns (uint256)',
                        'function approve(address, uint256) returns (bool)'
                    ], 
                    signer
                );
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ
                const balance = await tokenContract.balanceOf(userAddress);
                const feeInWei = ethers.utils.parseUnits(fee.toString(), 18);
                
                if (balance.lt(feeInWei)) {
                    gameStatusDiv.textContent = "Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª!";
                    return;
                }
                
                // ØªØ§ÛŒÛŒØ¯ Ù…Ø¬ÙˆØ² Ø¨Ø±Ø§ÛŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¨Ø§Ø²ÛŒ
                const txApprove = await tokenContract.approve(CONTRACT_ADDRESS, feeInWei);
                await txApprove.wait();
                
                // ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ
                const txJoin = await contract.joinGame(feeInWei);
                await txJoin.wait();
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
                entrySection.classList.add('hidden');
                waitingSection.classList.remove('hidden');
                gameStatusDiv.textContent = "Ù…Ù†ØªØ¸Ø± Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ø¯ÛŒÚ¯Ø±...";
                
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ:", error);
                gameStatusDiv.textContent = "Ø®Ø·Ø§ Ø¯Ø± ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø¨Ø§Ø²ÛŒ";
            }
        }
        
        // =============== ØªØ§Ø¨Ø¹ Ø­Ø±Ú©Øª Ø¯Ø± Ø¨Ø§Ø²ÛŒ ===============
        async function makeMove(isA) {
            try {
                // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø­Ø±Ú©Øª ØªÚ©Ø±Ø§Ø±ÛŒ
                if (lastMoveType === isA) {
                    gameStatusDiv.textContent = "Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¯Ùˆ Ø­Ø±Ú©Øª Ù¾Ø´Øª Ø³Ø± Ù‡Ù… ÛŒÚ©Ø³Ø§Ù† Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯!";
                    return;
                }
                
                // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ø­ÛŒÙ† Ù¾Ø±Ø¯Ø§Ø²Ø´
                btnA.disabled = true;
                btnL.disabled = true;
                
                // Ø§Ø±Ø³Ø§Ù„ ØªØ±Ø§Ú©Ù†Ø´ Ø­Ø±Ú©Øª
                const tx = await contract.moveCar(isA);
                await tx.wait();
                
                // Ø«Ø¨Øª Ù†ÙˆØ¹ Ø­Ø±Ú©Øª Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø­Ø±Ú©Øª ØªÚ©Ø±Ø§Ø±ÛŒ
                lastMoveType = isA;
                
                // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ù…Ø®Ø§Ù„Ù Ø¨Ø±Ø§ÛŒ Ø­Ø±Ú©Øª Ø¨Ø¹Ø¯ÛŒ
                if (isA) {
                    btnL.disabled = false;
                } else {
                    btnA.disabled = false;
                }
                
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø§Ù†Ø¬Ø§Ù… Ø­Ø±Ú©Øª:", error);
                gameStatusDiv.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§Ù†Ø¬Ø§Ù… Ø­Ø±Ú©Øª";
                btnA.disabled = false;
                btnL.disabled = false;
            }
        }
        
        // =============== ØªÙ†Ø¸ÛŒÙ… Ú¯ÙˆØ´â€ŒØ¯Ù‡ÛŒ Ø¨Ù‡ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ ===============
        function setupEventListeners() {
            // Ø±ÙˆÛŒØ¯Ø§Ø¯ ÙˆØ±ÙˆØ¯ Ø¨Ø§Ø²ÛŒÚ©Ù† Ø¬Ø¯ÛŒØ¯
            contract.on("PlayerJoined", (player, fee) => {
                updateWaitingPlayers();
            });
            
            // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø´Ø±ÙˆØ¹ Ù…Ø³Ø§Ø¨Ù‚Ù‡
            contract.on("RaceStarted", () => {
                startCountdown();
            });
            
            // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ù†Ø¬Ø§Ù… Ø­Ø±Ú©Øª
            contract.on("MoveMade", (player, newPosition) => {
                updateCarPosition(player, newPosition);
            });
            
            // Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ø¹Ù„Ø§Ù… Ø¨Ø±Ù†Ø¯Ù‡
            contract.on("WinnerDeclared", (winner, prize) => {
                showWinner(winner, prize);
            });
        }
        
        // =============== Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù† Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ===============
        async function updateWaitingPlayers() {
            try {
                const players = await contract.getPlayers();
                
                player1Div.textContent = players[0] !== ethers.constants.AddressZero 
                    ? `${players[0].substring(0, 6)}...${players[0].substring(38)}` 
                    : "Ù…Ù†ØªØ¸Ø±...";
                    
                player2Div.textContent = players[1] !== ethers.constants.AddressZero 
                    ? `${players[1].substring(0, 6)}...${players[1].substring(38)}` 
                    : "Ù…Ù†ØªØ¸Ø±...";
                    
                player3Div.textContent = players[2] !== ethers.constants.AddressZero 
                    ? `${players[2].substring(0, 6)}...${players[2].substring(38)}` 
                    : "Ù…Ù†ØªØ¸Ø±...";
                    
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¨Ø§Ø²ÛŒÚ©Ù†Ø§Ù†:", error);
            }
        }
        
        // =============== Ø´Ù…Ø§Ø±Ø´ Ù…Ø¹Ú©ÙˆØ³ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ ===============
        function startCountdown() {
            let count = 3;
            countdownDiv.textContent = count;
            countdownDiv.classList.remove('hidden');
            
            countdownInterval = setInterval(() => {
                count--;
                countdownDiv.textContent = count;
                
                if (count === 0) {
                    clearInterval(countdownInterval);
                    waitingSection.classList.add('hidden');
                    raceSection.classList.remove('hidden');
                    
                    // ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§ÙˆÙ„ÛŒÙ† Ø­Ø±Ú©Øª (A)
                    btnA.disabled = false;
                    lastMoveType = null;
                    
                    gameStatusDiv.textContent = "Ø´Ø±ÙˆØ¹ Ù…Ø³Ø§Ø¨Ù‚Ù‡! Ø­Ø±Ú©Øª Ø§ÙˆÙ„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯";
                }
            }, 1000);
        }
        
        // =============== Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ø§Ø´ÛŒÙ†â€ŒÙ‡Ø§ ===============
        async function updateCarPosition(player, newPosition) {
            try {
                const playerIdx = await contract.getPlayerIndex(player);
                const progress = Math.min(100, (newPosition / 100) * 100);
                
                if (playerIdx === 0) {
                    car1.style.left = `${progress}%`;
                } else if (playerIdx === 1) {
                    car2.style.left = `${progress}%`;
                } else if (playerIdx === 2) {
                    car3.style.left = `${progress}%`;
                }
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø§Ø²ÛŒ
                gameStatusDiv.textContent = `Ø¨Ø§Ø²ÛŒÚ©Ù† ${playerIdx + 1} Ø­Ø±Ú©Øª Ú©Ø±Ø¯!`;
                
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª:", error);
            }
        }
        
        // =============== Ù†Ù…Ø§ÛŒØ´ Ø¨Ø±Ù†Ø¯Ù‡ ===============
        async function showWinner(winner, prize) {
            try {
                raceSection.classList.add('hidden');
                resultSection.classList.remove('hidden');
                
                const formattedPrize = ethers.utils.formatUnits(prize, 18);
                
                if (winner === userAddress) {
                    winnerInfoDiv.textContent = `ğŸ‰ Ø´Ù…Ø§ Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯ÛŒØ¯! ${formattedPrize} ØªÙˆÚ©Ù† Ø¬Ø§ÛŒØ²Ù‡ Ú¯Ø±ÙØªÛŒØ¯!`;
                } else {
                    winnerInfoDiv.textContent = `Ø¨Ø§Ø²ÛŒÚ©Ù† ${winner.substring(0, 6)}...${winner.substring(38)} Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯ Ùˆ ${formattedPrize} ØªÙˆÚ©Ù† Ø¬Ø§ÛŒØ²Ù‡ Ú¯Ø±ÙØª!`;
                }
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ
                await updateTokenBalance();
                
            } catch (error) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¨Ø±Ù†Ø¯Ù‡:", error);
            }
        }
        
        // =============== Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ===============
        window.addEventListener('load', () => {
            // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ ØªØ§ Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ
            btnA.disabled = true;
            btnL.disabled = true;
        });
    </script>
</body>
</html>