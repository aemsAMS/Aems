<?php

// ----- تنظیمات خیلی ساده ----- //
$ADMIN_KEY = "CHANGE_ME_ADMIN_KEY"; // این را عوض کن

// مسیر فایل‌های دیتا
$lotteryFile = "data/lottery.json";
$contentFile = "data/content.json";
$archiveFile = "data/archive.json";

// خواندن فایل
function readJson($file) {
    return json_decode(file_get_contents($file), true);
}

// نوشتن فایل
function writeJson($file, $data) {
    file_put_contents($file, json_encode($data, JSON_PRETTY_PRINT));
}

// دریافت پارامتر action
$action = $_GET["action"] ?? null;

// حالت GET → دریافت تمام داده‌ها
if ($action === "get") {
    echo json_encode([
        "lottery" => readJson($GLOBALS['lotteryFile']),
        "content" => readJson($GLOBALS['contentFile']),
        "archive" => readJson($GLOBALS['archiveFile'])
    ]);
    exit;
}

// حالت POST → تغییرات مدیریتی
$input = json_decode(file_get_contents("php://input"), true);

// چک کردن کلید مدیر
if (($input["key"] ?? "") !== $ADMIN_KEY) {
    echo json_encode(["error" => "invalid_key"]);
    exit;
}

switch ($action) {

    case "setLottery": 
        writeJson($lotteryFile, [
            "ended" => true,
            "top3" => $input["top3"]
        ]);
        echo json_encode(["ok" => true]);
        break;

    case "setContent":
        writeJson($contentFile, [
            "ended" => true,
            "top3" => $input["top3"]
        ]);
        echo json_encode(["ok" => true]);
        break;

    case "resetAll":
        writeJson($lotteryFile, ["ended" => false, "top3" => []]);
        writeJson($contentFile, ["ended" => false, "top3" => []]);
        echo json_encode(["reset" => true]);
        break;

    case "addArchive":
        $archive = readJson($archiveFile);
        $archive["records"][] = $input["record"];
        writeJson($archiveFile, $archive);
        echo json_encode(["ok" => true]);
        break;

    default:
        echo json_encode(["error" => "unknown_action"]);
        break;
}

?>
