<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ØµÙØ­Ù‡ Ù…Ø³Ø§Ø¨Ù‚Ø§Øª (Ø¹Ù…ÙˆÙ…ÛŒ)</title>
<style>
  body{font-family:sans-serif;background:#0d0d0d;color:#fff;margin:0;padding:20px;}
  .card{background:linear-gradient(135deg,#111,#222);padding:16px;border-radius:12px;box-shadow:0 0 20px rgba(0,255,255,0.08);margin-bottom:16px}
  h1,h2{color:#0ff;margin:0 0 8px 0}
  .timer{font-family:monospace;color:#0ff;margin-bottom:12px}
  .list{display:flex;flex-wrap:wrap;gap:8px}
  .item{background:#0b0b0b;padding:8px;border-radius:8px;min-width:160px}
  input,button{padding:10px;border-radius:8px;border:none}
  input{width:100%;background:#121212;color:#fff;margin-bottom:8px}
  button{background:linear-gradient(45deg,#0ff,#0f0);cursor:pointer;color:#000;font-weight:700}
  .small{font-size:13px;color:#aaa}
  a.link{color:#0ff;text-decoration:underline}
</style>
</head>
<body>
  <div class="card">
    <h1>ğŸ‰ Ù…Ø³Ø§Ø¨Ù‚Ø§Øª Ø±Ø³Ù…ÛŒ</h1>
    <p class="small">Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¨Ø±ÙˆØ² Ø§Ø³Øª â€” Ù†ØªØ§ÛŒØ¬ Ù…Ø´ØªØ±Ú© Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§</p>
  </div>

  <div id="lottery" class="card">
    <h2>Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ 72 Ø³Ø§Ø¹ØªÙ‡</h2>
    <div class="timer" id="lotteryTimer">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
    <div id="lotteryList" class="list"></div>
    <div style="margin-top:12px">
      <input id="lotteryWallet" placeholder="Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ø´Ø±Ú©Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
      <button id="lotteryJoin">Ø´Ø±Ú©Øª Ø¯Ø± Ù‚Ø±Ø¹Ù‡â€ŒÚ©Ø´ÛŒ</button>
    </div>
  </div>

  <div id="content" class="card">
    <h2>Ù…Ø³Ø§Ø¨Ù‚Ù‡ ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§ 7 Ø±ÙˆØ²Ù‡</h2>
    <div class="timer" id="contentTimer">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
    <div id="contentList" class="list"></div>
    <div style="margin-top:12px">
      <input id="contentWallet" placeholder="Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙ Ù¾ÙˆÙ„">
      <input id="contentPost" placeholder="Ù„ÛŒÙ†Ú© Ù¾Ø³Øª (Ø¹Ù…ÙˆÙ…ÛŒ)">
      <button id="contentSubmit">Ø§Ø±Ø³Ø§Ù„ Ù…Ø­ØªÙˆØ§</button>
    </div>
  </div>

  <div id="archiveCard" class="card">
    <h2>Ø¢Ø±Ø´ÛŒÙˆ Ù†ÙØ± Ø§ÙˆÙ„</h2>
    <div id="archiveGrid" class="list"></div>
  </div>

<script>
const API = './api.php'; // Ø§Ú¯Ø± Ù…Ø³ÛŒØ± Ù…ØªÙØ§ÙˆØª Ø§Ø³Øª Ø§ÛŒÙ† Ø±Ø§ ØªØºÛŒÛŒØ± Ø¨Ø¯Ù‡

// fetch helpers
async function apiGet(resource) {
  const r = await fetch(`${API}?resource=${resource}&action=get`);
  return r.json();
}
async function apiPost(resource, action, body, adminKey = null) {
  const url = `${API}?resource=${resource}&action=${action}` + (adminKey ? `&admin_key=${encodeURIComponent(adminKey)}` : '');
  const r = await fetch(url, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(body || {})
  });
  return r.json();
}

// UI rendering
function showList(containerId, data, ended=false) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  if(!data) return;
  if(!ended) {
    // show participants (scrollable style)
    data.participants.slice().reverse().forEach(p => {
      const el = document.createElement('div'); el.className='item';
      el.textContent = p.wallet;
      container.appendChild(el);
    });
  } else {
    // show top3
    if(Array.isArray(data.top3) && data.top3.length) {
      data.top3.forEach(t => {
        const el = document.createElement('div'); el.className='item';
        el.innerHTML = `<strong>${t.wallet}</strong><div class="small">${t.prize || ''}</div>`;
        container.appendChild(el);
      });
    } else {
      container.innerHTML = '<div class="small">Ù†ØªØ§ÛŒØ¬ Ù‡Ù†ÙˆØ² Ø§Ø¹Ù„Ø§Ù… Ù†Ø´Ø¯Ù‡</div>';
    }
  }
}

let lotteryData = null, contentData = null;
let lotteryTime = 72*3600, contentTime = 7*24*3600;

async function refreshAll() {
  lotteryData = await apiGet('lottery');
  contentData = await apiGet('content');
  const archive = await apiGet('archive');

  // timers (we rely on server-independent countdown; client shows remaining if data contains remaining seconds later)
  // For simplicity keep local countdown starting values (could be improved to use server timestamps)
  document.getElementById('lotteryTimer').textContent = lotteryData.ended ? 'Ù…Ø³Ø§Ø¨Ù‚Ù‡ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡' : formatTime(lotteryTime);
  document.getElementById('contentTimer').textContent = contentData.ended ? 'Ù…Ø³Ø§Ø¨Ù‚Ù‡ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡' : formatTime(contentTime);

  showList('lotteryList', lotteryData, lotteryData.ended);
  showList('contentList', contentData, contentData.ended);
  renderArchive(archive);
}

function formatTime(s){
  const d=Math.floor(s/86400), h=Math.floor((s%86400)/3600), m=Math.floor((s%3600)/60), sec=s%60;
  return `${d?d+'d ':''}${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
}

// join lottery
document.getElementById('lotteryJoin').addEventListener('click', async ()=>{
  const wallet = document.getElementById('lotteryWallet').value.trim();
  await apiPost('lottery','add_participant', {wallet});
  await refreshAll();
  alert('Ø«Ø¨Øª Ø´Ø¯ (Ø§Ú¯Ø± Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ù‡Ù†ÙˆØ² Ø¨Ø§Ø² Ø¨Ø§Ø´Ø¯)');
});

// submit content
document.getElementById('contentSubmit').addEventListener('click', async ()=>{
  const wallet = document.getElementById('contentWallet').value.trim();
  const post = document.getElementById('contentPost').value.trim();
  if(!wallet||!post){ alert('Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø± Ú©Ù†ÛŒØ¯'); return; }
  await apiPost('content','add_participant', {wallet, postLink: post});
  await refreshAll();
  alert('Ù…Ø­ØªÙˆØ§ Ø«Ø¨Øª Ø´Ø¯ (Ø§Ú¯Ø± Ù…Ø³Ø§Ø¨Ù‚Ù‡ Ù‡Ù†ÙˆØ² Ø¨Ø§Ø² Ø¨Ø§Ø´Ø¯)');
});

// render archive
function renderArchive(obj) {
  const grid = document.getElementById('archiveGrid');
  grid.innerHTML='';
  if(!obj || !Array.isArray(obj.records)) return;
  obj.records.slice().reverse().forEach(r=>{
    const el=document.createElement('div'); el.className='item';
    el.innerHTML = `<div style="min-width:120px"><img src="${r.thumbnail||''}" style="width:120px;height:80px;object-fit:cover;border-radius:8px"></div>
      <div><strong>${r.wallet}</strong><div class="small">${r.category} â€¢ ${r.prize}</div>
      ${r.postLink?'<div><a class="link" href="'+r.postLink+'" target="_blank">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø³Øª</a></div>':''}
      </div>`;
    grid.appendChild(el);
  });
}

// initial
refreshAll();
// simple client-side countdown tick for UI only
setInterval(()=>{
  if(lotteryTime>0) { lotteryTime--; document.getElementById('lotteryTimer').textContent = formatTime(lotteryTime); }
  if(contentTime>0) { contentTime--; document.getElementById('contentTimer').textContent = formatTime(contentTime); }
},1000);

// refresh from server every 12s
setInterval(refreshAll, 12000);
</script>
</body>
</html>
